---
title: "Collecting and Identification the Outbreak Cluster"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Collecting and Identification the Outbreak Cluster}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The goal of Collecting and Identification the Outbreak Cluster (caIRA) is to find the cluster based tree and metadata of the data. The package is based on the paper:

Ragonnet-Cronin, M., Hodcroft, E., Hué, S. et al. Automated analysis of phylogenetic clusters. BMC Bioinformatics 14, 317 (2013). <https://doi.org/10.1186/1471-2105-14-317>

Hall M, Woolhouse M, Rambaut A (2015) Epidemic Reconstruction in a Phylogenetics Framework: Transmission Trees as Partitions of the Node Set. PLoS Comput Biol 11(12): e1004613. <https://doi.org/10.1371/journal.pcbi.1004613>

This package is the part of Dhihram Tenrisau, MSc Health Data Science summer project, 'Phylodynamic of Norovirus in UK 2003-2023'. The project is supervised by Stéphane Hué.

By using this package, the hope will be emerging (not the the disease emerging) like the lyrics of the song 'Ah Ça Ira':

*Ah ça ira, réjouis-toi!* (It'll be fine, rejoice!)

*Ah ça ira, le bon temps viendra* (It'll be fine, good times will come)

## Installation

You can install the development version of huebreaker from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("Dhihram/caIRA")
```

## Example

This package needs the additional package `tidyverse`, `ape`, `treeio`, and `dplyr`

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(ape)
library(dplyr)
library(treeio)
library(caIRA)
```

### Data

You need the 2 data in this file, the first data is tree files (newick or nexus) and metadata file. The metadata file consists of `label`, `location`, and `date` columns. The `label` column must be same with the label in tree file.

```{r}
#open data
tree <- read.tree("https://raw.githubusercontent.com/Dhihram/huebreaker/master/data/random_tree.nwk")
metat <- read.csv("https://raw.githubusercontent.com/Dhihram/huebreaker/master/data/random_metadata.csv")

#change date format
metat$date <- as.Date(metat$date, format = "%m/%d/%Y")

#check the data
str(tree)
str(metat)
```

The intial tree can be seen below with `ggtree` package

```{r, message = FALSE, warning = FALSE}
library(ggtree)
gg <- ggtree(tree) + geom_tiplab(size = 2)+
  geom_text2(aes(subset=!isTip, label=label),
             size = 3,
             color = "#0063B1",
             hjust = 1,
             vjust = -1.5) + ggtitle("Random Phylogenetic Tree with Bootstrap Values")
gg
```

### Package Utilization

This part of package, `genclus` will utilize:

1.  Finding and clustering the monophylectic groups in the tree

2.  Add the parameter of the clusters: `bootstrap_treshold`, `data_range`, and `samearea`

3.  Keep the maximum monophylectic groups in the cluster identify

The `bootstrap_treshold` is the minimum bootstrap value to be considered as a cluster. The `data_range` is the range of the days to be considered as a cluster. The `samearea` is the boolean value to consider the same area as a cluster.

```{r}
res <- genclus(tree, metat, bootstrap_threshold = 80, date_range = 30, samearea = TRUE)
knitr::kable(res)
```

We can check the clusters in tree

```{r}
# Highlight all parent nodes
for (node in res$ParentNode) {
  gg_clus <- gg +
    geom_hilight(node = res$ParentNode, fill = "gold", alpha = 0.5)
}
gg_clus
```

## Generating from BEAST tree

Since BEAST tree has different structure of the tree, we developed `beastclus`. In BEAST tree, the bootstrapping value is posterior probability with scale 0-1. The beast tree is exported using `read.beast` from `treeio` In this example, I will use the Monkeypox phylogenetic tree and metadata from GISAID:

```{r}
#beast tree

beast_tree <- read.beast('https://raw.githubusercontent.com/Dhihram/caIRA/refs/heads/master/inst/extdata/pox_strict_comb.tree')

#metadata
metadata<-read.csv('https://raw.githubusercontent.com/Dhihram/caIRA/refs/heads/master/inst/extdata/metadata_samp.csv')

```

Generating cluster

```{r}
res2 <- beastclus(beast_tree, metadata, post_threshold = 0.50, date_range = 90, samearea = TRUE)
knitr::kable(res2)
```

Also, we can check the clusters in tree

```{r}
tr <- ggtree(beast_tree, mrsd = min(metadata$date)) +
  theme_tree2() 
# Replace `highlight_nodes` with the node numbers or clade labels you want to highlight
n <- as.numeric(res2$ParentNode)
tr + 
  geom_highlight(node = n, fill = "lightblue", alpha = 0.5)
```
